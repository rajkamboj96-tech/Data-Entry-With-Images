<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>App Default Pro</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { 
            --primary: #6366f1; 
            --bg: #f8fafc; 
            --card-bg: #ffffff; 
            --border: #f1f5f9; 
            --success: #34d399; 
            --accent: #f472b6; 
            --danger: #ef4444;
        }
        
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; color: #334155; user-select: none; }

        header { 
            background: linear-gradient(135deg, var(--primary), var(--accent)); 
            color: white; padding: 18px; display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        
        .header-btns { display: flex; gap: 8px; align-items: center; }
        .icon-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; border-radius: 8px; padding: 6px 10px; cursor: pointer; font-size: 1.2rem; line-height: 1; }

        .entry-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: white; border-bottom: 1px solid var(--border); }
        .opt-card { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 16px; cursor: pointer; background: #fff; transition: 0.3s; }
        
        .search-area { padding: 12px 15px; background: white; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; align-items: center; }
        .search-select { padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; outline: none; background: #f1f5f9; font-weight: 600; color: var(--primary); width: 100%; appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236366f1%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; }
        .search-input-group { display: flex; gap: 5px; width: 100%; }
        .search-bar { padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; outline: none; background: #f8fafc; width: 100%; }

        #dataList { padding: 15px; display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
        .card { background: white; border-radius: 16px; padding: 12px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid #f1f5f9; touch-action: pan-y; -webkit-tap-highlight-color: transparent; transition: transform 0.1s; }
        .card:active { transform: scale(0.98); }
        .card-img { width: 65px; height: 65px; border-radius: 12px; object-fit: cover; background: #f1f5f9; flex-shrink: 0; }
        
        .fab { position: fixed; bottom: 85px; right: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 15px rgba(99, 102, 241, 0.4); font-size: 32px; border: none; z-index: 100; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center; padding: 10px; box-sizing: border-box; }
        .modal-content { background:white; width:100%; max-width:500px; padding:20px; border-radius:20px; max-height:90vh; overflow-y:auto; position: relative; }
        
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; color: #94a3b8; cursor: pointer; z-index: 10; line-height: 1; transition: 0.2s; }
        .close-btn:hover { color: var(--danger); transform: scale(1.1); }
        .close-btn-overlay { position: absolute; top: 30px; right: 30px; font-size: 45px; font-weight: bold; color: white; cursor: pointer; z-index: 2000; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        .form-group { display: flex; align-items: center; margin-bottom: 0; border-bottom: 1px solid #f1f5f9; padding: 0; }
        .form-group:last-child { border-bottom: none; }
        .form-group label { display: block; flex: 0 0 35%; font-size: 0.8rem; font-weight: 700; color: #64748b; text-transform: uppercase; padding: 15px 5px 15px 0; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .form-group input { flex: 1; width: 100%; padding: 15px 0; border: none; background: transparent; font-size: 1rem; color: #334155; outline: none; }
        .form-group input:focus { background: rgba(99, 102, 241, 0.05); }

        /* --- NEW CSS FOR DIM PLACEHOLDER --- */
        .form-group input::placeholder {
            color: #cbd5e1; /* Very light grey */
            font-style: italic; /* Slight italic for watermark feel */
            opacity: 1; /* Ensure consistency across browsers */
        }
        /* ---------------------------------- */

        .summary-container { display: flex; flex-direction: column; gap: 12px; }
        .summary-card { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .summary-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; display: block; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; font-size: 0.95rem; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85rem; }
        .stat-item { display: flex; justify-content: space-between; align-items: center; }
        .stat-label { color: #64748b; }
        .stat-val { font-weight: 700; color: #334155; }

        .reorder-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 8px; border-radius: 10px; }
        .reorder-btns { display: flex; gap: 5px; }
        .reorder-btn { padding: 8px 12px; background: #fff; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; }

        .footer { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .btn { padding: 12px 18px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; }
        .btn-zip { background: var(--success); color: white; }
        .hidden { display: none !important; }

        .context-btn { width: 100%; padding: 15px; text-align: left; background: white; border: none; border-bottom: 1px solid #f1f5f9; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .context-btn:last-child { border-bottom: none; }
        .context-btn:hover { background: #f8fafc; }
    </style>
</head>
<body>

<header>
    <div style="display: flex; flex-direction: column;">
        <h1 style="font-size: 1.2rem; margin:0; font-weight: 800;">
            App Default Pro 
            <span style="font-size: 10px; font-weight: 400; margin-left: 8px; opacity: 0.9;">made by Raj Kamboj 9465428299</span>
        </h1>
    </div>
    <div class="header-btns">
        <button class="icon-btn" onclick="openSettings()" title="Header Settings">‚öôÔ∏è</button>
        <button onclick="clearData()" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.5); color:white; border-radius:8px; padding:6px 12px; cursor: pointer; font-size: 0.8rem;">Reset</button>
    </div>
</header>

<div class="entry-options" id="setupArea">
    <div class="opt-card" onclick="document.getElementById('excelInput').click()">
        <strong>Step 1: Excel</strong>
        <input type="file" id="excelInput" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleExcel(this)">
    </div>
    <div class="opt-card" onclick="document.getElementById('zipInput').click()">
        <strong>Step 2: ZIP</strong>
        <input type="file" id="zipInput" accept=".zip" class="hidden" onchange="handleZip(this)">
    </div>
</div>

<div class="search-area">
    <select id="filterColumn" class="search-select" onchange="filterList()">
        <option value="all">Show All Records</option>
    </select>
    
    <div class="search-input-group">
        <input type="text" class="search-bar" id="search" placeholder="Type to find..." onkeyup="filterList()">
        <button onclick="showSummary()" style="border:none; background: #e0e7ff; color:var(--primary); border-radius:10px; width:45px; cursor:pointer; font-size: 1.2rem;">üìä</button>
    </div>
</div>

<div id="dataList"></div>

<button id="addFab" class="fab hidden" onclick="openModalForNew()">+</button>

<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <div style="display:flex; gap:15px; margin-bottom:20px; padding-right: 40px; align-items: center;">
            <img id="editPreview" style="width:60px; height:60px; border-radius:12px; object-fit:cover; border: 1px solid #eee; cursor:pointer;" onclick="showFullImageFromPreview()">
            <input type="file" accept="image/*" onchange="processPhoto(this)">
        </div>
        
        <div id="editFields" style="border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9;"></div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn" onclick="saveRecord()" style="background:var(--primary); color:white; flex: 2;">Save</button>
            <button class="btn" onclick="deleteFromModal()" style="background:var(--danger); color:white; flex: 1;">Delete</button>
            <button class="btn" onclick="closeModal()" style="background:#f1f5f9; color: #64748b; flex: 1;">Cancel</button>
        </div>
    </div>
</div>

<div id="contextModal" class="modal" style="align-items: flex-end; padding: 0;">
    <div class="modal-content" style="width: 100%; max-width: 100%; border-radius: 20px 20px 0 0; padding: 0; overflow: hidden;">
        <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-weight: bold; color: #64748b; display: flex; justify-content: space-between;">
            <span>Options</span>
            <span onclick="closeContextModal()" style="cursor: pointer;">&times;</span>
        </div>
        <button class="context-btn" onclick="copyCardData()"><span>üìã</span> Copy Text</button>
        <button class="context-btn" onclick="duplicateRecord()"><span>üìë</span> Duplicate Record</button>
        <button class="context-btn" onclick="deleteFromContext()" style="color: var(--danger);"><span>üóë</span> Delete</button>
        <div style="height: 20px;"></div>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeSettings()">&times;</span>
        <h3 style="margin-top:0">Interface Settings</h3>
        <p style="font-size:0.8rem; color:#64748b;">1. <b>First Item:</b> Bold Title.<br>2. <b>Second Item:</b> Subtitle.</p>
        <div id="reorderContainer"></div>
        <button class="btn" onclick="closeSettings()" style="width:100%; margin-top:20px; background:var(--primary); color:white;">Done & Apply</button>
    </div>
</div>

<div id="summaryModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('summaryModal').style.display='none'">&times;</span>
        <h3 style="margin-top: 0; border-bottom:1px solid #eee; padding-bottom:10px;">Detailed Analytics</h3>
        <div id="summaryBody"></div>
        <button class="btn" onclick="this.parentElement.parentElement.style.display='none'" style="width:100%; margin-top:20px; background:var(--primary); color:white;">Close</button>
    </div>
</div>

<div id="imageModal" class="modal" onclick="this.style.display='none'" style="background:rgba(0,0,0,0.9);">
    <span class="close-btn-overlay" onclick="document.getElementById('imageModal').style.display='none'">&times;</span>
    <img id="fullImageDisplay" style="max-width:95%; max-height:80vh; border-radius:12px;">
</div>

<div class="footer">
    <span id="status">Waiting for data...</span>
    <button class="btn btn-zip" onclick="exportZip()">Download ZIP</button>
</div>

<script>
    let globalData = [];
    let currentHeaders = []; 
    let displayOrder = [];   
    let editIdx = -1;
    let contextIdx = -1; 
    let db; 
    let pressTimer; 
    let appPassword = ""; 
    
    const DB_NAME = "BoothProDB";
    const STORE_NAME = "ProjectStore";
    let tempFullImage = null;
    let tempThumbImage = null;

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
            };
            request.onsuccess = (e) => { db = e.target.result; resolve(db); };
            request.onerror = (e) => reject("DB Error");
        });
    }

    async function saveData() {
        if(!db) await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, "readwrite");
            const store = tx.objectStore(STORE_NAME);
            const dataToSave = { id: "current", d: globalData, h: currentHeaders, order: displayOrder, pass: appPassword };
            const req = store.put(dataToSave, "current");
            req.onsuccess = () => {
                document.getElementById('status').innerText = "Data Saved Securely";
                setTimeout(() => document.getElementById('status').innerText = `${globalData.length} Records`, 2000);
                resolve();
            };
            req.onerror = () => reject("Save failed");
        });
    }

    async function loadData() {
        if(!db) await openDB();
        return new Promise((resolve) => {
            const tx = db.transaction(STORE_NAME, "readonly");
            const store = tx.objectStore(STORE_NAME);
            const req = store.get("current");
            req.onsuccess = () => {
                if(req.result) {
                    globalData = req.result.d;
                    currentHeaders = req.result.h;
                    displayOrder = req.result.order || [...currentHeaders];
                    appPassword = req.result.pass || "";
                    initApp();
                }
                resolve();
            };
            req.onerror = () => resolve(null);
        });
    }

    async function clearData() { 
        if (appPassword) {
            const input = prompt("This project is password protected.\nEnter password to reset:");
            if (input !== appPassword) {
                return alert("Incorrect password or Cancelled. Reset Aborted.");
            }
        }
        if(confirm("Are you sure? This will delete all data.")) { 
            if(!db) await openDB();
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).clear();
            localStorage.clear(); 
            location.reload(); 
        } 
    }

    function handleExcel(input) {
        if (!input.files || !input.files[0]) return;
        
        // Prompt for password immediately
        const newPass = prompt("Set a password for this project (optional):\nClick Cancel to abort upload.");
        
        // REJECT if Cancel (null)
        if (newPass === null) {
            input.value = ""; // Clear input
            return; // Abort
        }

        appPassword = newPass; 
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = e => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:""});
            if(rows.length) {
                globalData = rows;
                currentHeaders = Object.keys(rows[0]).filter(k => k !== "Photo_Data" && k !== "Photo_Name" && k !== "Thumbnail_Data");
                displayOrder = [...currentHeaders]; 
                initApp();
                saveData(); 
            }
        };
        reader.readAsArrayBuffer(file);
        input.value = ""; 
    }

    async function handleZip(input) {
        if (!input.files || !input.files[0]) return;
        
        // Prompt for password immediately
        const newPass = prompt("Set a password for this project (optional):\nClick Cancel to abort upload.");
        
        // REJECT if Cancel (null)
        if (newPass === null) {
            input.value = ""; 
            return; // Abort
        }
        
        appPassword = newPass;
        const file = input.files[0];
        document.getElementById('status').innerText = "Processing ZIP...";
        
        const zip = new JSZip();
        try {
            const contents = await zip.loadAsync(file);
            const imgs = {};
            const thumbs = {};
            let rows = [];

            for (const [name, file] of Object.entries(contents.files)) {
                 if (name.match(/\.(jpg|jpeg|png)$/i) && !name.startsWith('__MACOSX')) {
                    const simpleName = name.split('/').pop().toLowerCase();
                    const b64 = await file.async("base64");
                    const finalB64 = `data:image/jpeg;base64,${b64}`;
                    if(name.includes('Thumbnails/')) {
                        thumbs[simpleName] = finalB64;
                    } else {
                        imgs[simpleName] = finalB64;
                    }
                }
            }

            for (const [name, file] of Object.entries(contents.files)) {
                if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
                    const b = await file.async("uint8array");
                    const wb = XLSX.read(b, {type:'array'});
                    rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:""});
                    currentHeaders = Object.keys(rows[0]).filter(k => k !== "Photo_Data" && k !== "Photo_Name" && k !== "Thumbnail_Data");
                    displayOrder = [...currentHeaders];
                }
            }

            globalData = rows.map(r => {
                const pCol = Object.keys(r).find(k => k.toLowerCase().includes('photo') || k.toLowerCase().includes('image'));
                if(pCol) {
                    const fileNameInSheet = String(r[pCol]).trim().toLowerCase();
                    if(imgs[fileNameInSheet]) {
                        r.Photo_Data = imgs[fileNameInSheet]; 
                        r.Thumbnail_Data = thumbs[fileNameInSheet] || imgs[fileNameInSheet]; 
                        r.Photo_Name = r[pCol]; 
                    }
                }
                return r;
            });

            initApp();
            saveData(); 
        } catch(e) {
            alert("Error reading ZIP file.");
            console.error(e);
        }
        input.value = "";
    }

    function initApp() {
        document.getElementById('setupArea').classList.add('hidden');
        document.getElementById('addFab').classList.remove('hidden');
        updateFilterDropdown();
        renderList();
    }

    function createThumbnail(base64, targetWidth) {
        return new Promise((resolve) => {
            const img = new Image();
            img.src = base64;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const scale = targetWidth / img.width;
                canvas.width = targetWidth;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                resolve(canvas.toDataURL('image/jpeg', 0.6)); 
            };
        });
    }

    function updateFilterDropdown() {
        const sel = document.getElementById('filterColumn');
        const currentVal = sel.value;
        sel.innerHTML = '<option value="all">Show All Records</option>';
        const headers = displayOrder.length ? displayOrder : currentHeaders;
        headers.forEach(h => {
            if(h !== "Photo_Data" && h !== "Photo_Name" && h !== "Thumbnail_Data") {
                const opt = document.createElement('option');
                opt.value = h;
                opt.innerText = `Only with ${h}`; 
                sel.appendChild(opt);
            }
        });
        if(currentVal && Array.from(sel.options).some(o => o.value === currentVal)) sel.value = currentVal;
    }

    function filterList() {
        const selectedColumn = document.getElementById('filterColumn').value;
        const searchText = document.getElementById('search').value.toLowerCase().trim();
        const filtered = globalData.filter(row => {
            if (selectedColumn !== "all") {
                const cellValue = row[selectedColumn];
                if (!cellValue || String(cellValue).trim() === "") return false;
            }
            if (searchText) {
                const rowHasText = Object.values(row).some(val => String(val).toLowerCase().includes(searchText));
                if (!rowHasText) return false;
            }
            return true;
        });
        renderList(filtered);
    }

    function renderList(data = globalData) {
        const list = document.getElementById('dataList');
        list.innerHTML = "";
        document.getElementById('status').innerText = `${data.length} Records`;
        const validFields = displayOrder.filter(k => k !== "Photo_Data" && k !== "Photo_Name" && k !== "Thumbnail_Data");
        const titleKey = validFields[0]; 
        const subKey = validFields[1]; 

        data.forEach((row) => {
            const originalIndex = globalData.indexOf(row);
            const card = document.createElement('div');
            card.className = 'card';
            let isLongPress = false;
            card.addEventListener('touchstart', (e) => {
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    if (window.navigator && window.navigator.vibrate) navigator.vibrate(50); 
                    openContextMenu(originalIndex);
                }, 800);
            }, {passive: true});
            card.addEventListener('touchend', () => clearTimeout(pressTimer));
            card.addEventListener('touchmove', () => clearTimeout(pressTimer));
            card.addEventListener('mousedown', () => {
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    openContextMenu(originalIndex);
                }, 800);
            });
            card.addEventListener('mouseup', () => clearTimeout(pressTimer));
            card.addEventListener('mouseleave', () => clearTimeout(pressTimer));
            card.onclick = (e) => { if(!isLongPress) openModal(originalIndex); };
            card.oncontextmenu = (e) => { e.preventDefault(); openContextMenu(originalIndex); return false; };

            const titleVal = titleKey ? (row[titleKey] || "Empty") : "No Data";
            const subVal = subKey ? `${subKey}: ${row[subKey] || '-'}` : "";
            const thumbSrc = row.Thumbnail_Data || row.Photo_Data || 'https://via.placeholder.com/65';
            const fullSrc = row.Photo_Data || thumbSrc; 

            card.innerHTML = `
                <img src="${thumbSrc}" class="card-img" onclick="showFullImage(event, '${fullSrc}')">
                <div style="pointer-events: none;">
                    <div style="font-weight:bold; color:var(--primary); font-size:1.1rem;">${titleVal}</div>
                    <div style="font-size:0.85rem; color:#64748b; margin-top: 3px;">${subVal}</div>
                </div>
            `;
            list.appendChild(card);
        });
        if(data.length === 0) list.innerHTML = `<div style="text-align:center; padding:20px; color:#94a3b8;">No matches found.</div>`;
    }

    function openContextMenu(index) { contextIdx = index; document.getElementById('contextModal').style.display = 'flex'; }
    function closeContextModal() { document.getElementById('contextModal').style.display = 'none'; contextIdx = -1; }

    function copyCardData() {
        if (contextIdx === -1) return;
        const row = globalData[contextIdx];
        let textToCopy = "";
        displayOrder.forEach(h => {
             if(h !== "Photo_Data" && h !== "Photo_Name" && h !== "Thumbnail_Data" && row[h]) textToCopy += `${h}: ${row[h]}\n`;
        });
        navigator.clipboard.writeText(textToCopy).then(() => { alert("Data copied to clipboard!"); closeContextModal(); });
    }

    function duplicateRecord() {
        if (contextIdx === -1) return;
        const original = globalData[contextIdx];
        const copy = {...original}; 
        const firstKey = displayOrder.find(k => k !== "Photo_Data");
        if(firstKey) copy[firstKey] = copy[firstKey] + " - Copy";
        globalData.splice(contextIdx + 1, 0, copy);
        saveData(); renderList(); closeContextModal();
    }

    function deleteFromContext() {
        if(contextIdx === -1) return;
        if(confirm("Permanently delete this record?")) {
            globalData.splice(contextIdx, 1);
            saveData(); renderList(); closeContextModal();
        }
    }

    function showFullImage(e, src) {
        e.stopPropagation();
        document.getElementById('fullImageDisplay').src = src;
        document.getElementById('imageModal').style.display = 'flex';
    }
    
    function showFullImageFromPreview() {
        const src = tempFullImage || document.getElementById('editPreview').src;
        if(src && !src.includes('placeholder')) {
             document.getElementById('fullImageDisplay').src = src;
             document.getElementById('imageModal').style.display = 'flex';
        }
    }

    function openModal(i) {
        editIdx = i;
        const row = globalData[i];
        const imgSrc = row.Thumbnail_Data || row.Photo_Data || "https://via.placeholder.com/100";
        document.getElementById('editPreview').src = imgSrc;
        tempFullImage = row.Photo_Data; 
        tempThumbImage = row.Thumbnail_Data;
        const container = document.getElementById('editFields');
        container.innerHTML = "";
        displayOrder.forEach(h => {
            if(h === "Photo_Data" || h === "Photo_Name" || h === "Thumbnail_Data") return;
            container.innerHTML += `<div class="form-group"><label>${h}</label><input type="text" id="edit-${h}" value="${row[h] || ''}" placeholder="Enter ${h}"></div>`;
        });
        document.getElementById('editModal').style.display = 'flex';
    }

    function openModalForNew() {
        editIdx = -1;
        tempFullImage = null;
        tempThumbImage = null;
        document.getElementById('editPreview').src = "https://via.placeholder.com/100";
        const container = document.getElementById('editFields');
        container.innerHTML = "";
        displayOrder.forEach(h => {
            if(h === "Photo_Data" || h === "Photo_Name" || h === "Thumbnail_Data") return;
            container.innerHTML += `<div class="form-group"><label>${h}</label><input type="text" id="edit-${h}" value="" placeholder="Enter ${h}"></div>`;
        });
        document.getElementById('editModal').style.display = 'flex';
    }

    function deleteFromModal() {
        if (editIdx === -1) return;
        if(confirm("Are you sure you want to delete this record?")) {
            globalData.splice(editIdx, 1);
            saveData(); renderList(); closeModal();
        }
    }

    function processPhoto(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const fullBase64 = e.target.result;
                tempFullImage = fullBase64;
                const thumbBase64 = await createThumbnail(fullBase64, 180);
                tempThumbImage = thumbBase64;
                document.getElementById('editPreview').src = thumbBase64;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function saveRecord() {
        let row = editIdx === -1 ? {} : globalData[editIdx];
        if(editIdx === -1) globalData.push(row);
        displayOrder.forEach(h => {
            const val = document.getElementById(`edit-${h}`);
            if(val) row[h] = val.value;
        });
        if(tempFullImage) {
            row.Photo_Data = tempFullImage;
            row.Thumbnail_Data = tempThumbImage; 
            if (row.Photo_Data.startsWith('data:image') && !row.Photo_Name) row.Photo_Name = `p_${Date.now()}.jpg`;
        }
        closeModal(); renderList(); saveData(); 
    }

    async function exportZip() {
        document.getElementById('status').innerText = "Creating ZIP... (Please Wait)";
        const d = new Date();
        const timeStr = `${d.getFullYear()}${d.getMonth()+1}${d.getDate()}_${d.getHours()}${d.getMinutes()}${d.getSeconds()}`;
        const finalName = `Project_${timeStr}.zip`;
        const zip = new JSZip();
        
        const root = zip.folder("Project");
        const imgDir = root.folder("Images");      
        const thumbDir = root.folder("Thumbnails"); 

        let photoHeader = currentHeaders.find(k => k.toLowerCase().includes('photo') || k.toLowerCase().includes('image'));
        if (!photoHeader) photoHeader = "Photo_Ref";

        const clean = globalData.map(r => {
            const c = {};
            const allKeys = new Set([...currentHeaders, ...displayOrder]);
            allKeys.forEach(h => {
                if(h !== "Photo_Data" && h !== "Photo_Name" && h !== "Thumbnail_Data") c[h] = r[h] || "";
            });
            if (r.Photo_Name) c[photoHeader] = r.Photo_Name;
            return c; 
        });

        root.file("Data.xlsx", XLSX.write({SheetNames:["Data"], Sheets:{"Data":XLSX.utils.json_to_sheet(clean)}}, {bookType:'xlsx', type:'array'}));
        
        for (const r of globalData) {
            if(r.Photo_Data && r.Photo_Data.startsWith('data:image')) {
                const fName = r.Photo_Name || `p_${Date.now()}.jpg`;
                
                imgDir.file(fName, r.Photo_Data.split(',')[1], {base64:true});
                
                // GENERATE THUMBNAIL IF MISSING
                let thumbData = r.Thumbnail_Data;
                if (!thumbData) {
                    thumbData = await createThumbnail(r.Photo_Data, 180);
                    r.Thumbnail_Data = thumbData; 
                }
                thumbDir.file(fName, thumbData.split(',')[1], {base64:true});
            }
        }

        zip.generateAsync({type:"blob"}).then(blob => {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = finalName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => document.body.removeChild(a), 100);
            document.getElementById('status').innerText = `${globalData.length} Records`;
        });
    }

    function showSummary() {
        if(!globalData.length) return alert("Load data first");
        const container = document.getElementById('summaryBody');
        container.innerHTML = `<div class="summary-container"></div>`;
        const wrap = container.querySelector('.summary-container');
        const total = globalData.length;
        const withPhoto = globalData.filter(r => r.Photo_Data).length;
        wrap.innerHTML += `
            <div class="summary-card" style="background: #e0e7ff; border-color: #c7d2fe;">
                <strong class="summary-title" style="color:#4338ca; border-color:#c7d2fe;">Global Overview</strong>
                <div class="stat-grid">
                    <div class="stat-item"><span class="stat-label">Total Records</span><span class="stat-val">${total}</span></div>
                    <div class="stat-item"><span class="stat-label">Photos Linked</span><span class="stat-val" style="color:var(--success)">${withPhoto}</span></div>
                    <div class="stat-item"><span class="stat-label">Photos Missing</span><span class="stat-val" style="color:var(--accent)">${total - withPhoto}</span></div>
                </div>
            </div>`;
        const validFields = displayOrder.filter(k => k !== "Photo_Data" && k !== "Photo_Name" && k !== "Thumbnail_Data");
        validFields.forEach(h => {
            let filled = 0; let empty = 0; const valueCounts = {};
            globalData.forEach(row => { const val = String(row[h] || "").trim(); if(val) { filled++; valueCounts[val] = (valueCounts[val] || 0) + 1; } else { empty++; } });
            const unique = Object.keys(valueCounts).length;
            let topVal = "-"; let topCount = 0;
            Object.entries(valueCounts).forEach(([k, v]) => { if(v > topCount) { topVal = k; topCount = v; } });
            let displayTop = `${topVal} <span style="font-weight:400; font-size:0.8em; color:#94a3b8;">(${topCount})</span>`;
            if (filled === 0) displayTop = "<span style='color:#cbd5e1'>Empty Column</span>";
            wrap.innerHTML += `
                <div class="summary-card">
                    <strong class="summary-title">${h}</strong>
                    <div class="stat-grid">
                        <div class="stat-item"><span class="stat-label">Filled</span><span class="stat-val" style="color:var(--success)">${filled}</span></div>
                        <div class="stat-item"><span class="stat-label">Empty</span><span class="stat-val" style="color:var(--accent)">${empty}</span></div>
                        <div class="stat-item"><span class="stat-label">Unique</span><span class="stat-val">${unique}</span></div>
                        <div class="stat-item"><span class="stat-label">Top</span><span class="stat-val">${displayTop}</span></div>
                    </div>
                </div>`;
        });
        document.getElementById('summaryModal').style.display = 'flex';
    }

    function openSettings() {
        if(!currentHeaders.length && !displayOrder.length) return alert("Please load data first.");
        const container = document.getElementById('reorderContainer');
        container.innerHTML = "";
        displayOrder.forEach((header, index) => {
            if(header === "Photo_Data" || header === "Photo_Name" || header === "Thumbnail_Data") return;
            const item = document.createElement('div');
            item.className = 'reorder-item';
            let badge = "";
            if(index === 0) badge = `<span style="background:var(--primary); color:white; font-size:10px; padding:2px 6px; border-radius:4px; margin-right:5px;">TITLE</span>`;
            if(index === 1) badge = `<span style="background:#94a3b8; color:white; font-size:10px; padding:2px 6px; border-radius:4px; margin-right:5px;">SUB</span>`;
            item.innerHTML = `
                <div style="display:flex; align-items:center;">${badge}<span style="font-weight:600;">${header}</span></div>
                <div class="reorder-btns">
                    <button class="reorder-btn" onclick="moveHeader(${index}, -1)">‚Üë</button>
                    <button class="reorder-btn" onclick="moveHeader(${index}, 1)">‚Üì</button>
                </div>`;
            container.appendChild(item);
        });
        document.getElementById('settingsModal').style.display = 'flex';
    }

    function moveHeader(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= displayOrder.length) return;
        [displayOrder[index], displayOrder[newIndex]] = [displayOrder[newIndex], displayOrder[index]];
        openSettings();
    }

    function closeSettings() {
        document.getElementById('settingsModal').style.display = 'none';
        updateFilterDropdown();
        renderList();
        saveData(); 
    }

    function closeModal() { document.getElementById('editModal').style.display = 'none'; }

    window.onload = () => { loadData(); };
</script>
</body>
</html>
